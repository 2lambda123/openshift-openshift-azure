apiVersion: v1
data:
  fluent.conf: |
    <source>
      @type systemd
      <storage>
        @type local
        path /var/log/journald.pos
      </storage>
      tag logs
    </source>
    <match logs>
      @type rewrite_tag_filter
      <rule>
        key MESSAGE
        pattern audit\.k8s\.io
        tag audit
      </rule>
      <rule>
        key MESSAGE
        pattern .+
        tag journald
      </rule>
    </match>
    <filter journald>
      @type record_transformer
      enable_ruby true
      <record>
       #k8s_apiserver_apiserver-vqxg4_kube-service-catalog_72ce4d73-5224-11e9-98d0-000d3a196756_0
       CONTAINER ${record["CONTAINER_NAME"].split("_")[1]}
       POD ${record["CONTAINER_NAME"].split("_")[2]}
       NAMESPACE ${record["CONTAINER_NAME"].split("_")[3]}
       CONTAINER_ID ${record["CONTAINER_NAME"].split("_")[4]}
      </record>
    </filter>
    <match **>
      @type mdsd
      djsonsocket /var/run/mdsd/default_djson.socket
      acktimeoutms 5000
      buffer_chunk_limit 1000k
      buffer_type file
      buffer_path /var/log/td-agent/buffer
      buffer_queue_limit 128
      emit_timestamp_name time
      flush_interval 10s
      retry_limit 3
      retry_wait 10s
    </match>
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: openshift-azure-logging
