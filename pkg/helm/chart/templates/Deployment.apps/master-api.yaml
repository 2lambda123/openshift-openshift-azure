apiVersion: apps/v1
kind: Deployment
metadata:
  name: master-api
spec:
  replicas: 1
  selector:
    matchLabels:
      openshift.io/component: api
  template:
    metadata:
      labels:
        openshift.io/component: api
    spec:
      containers:
      - name: api
        image: {{ .Values.MasterAPIImage }}
        command:
        - /bin/bash
        - -c
        args:
        - |
          set -euo pipefail
          if [[ -f /etc/origin/master/master.env ]]; then
            set -o allexport
            source /etc/origin/master/master.env
          fi
          exec openshift start master api --config=/etc/origin/master/master-config.yaml --loglevel=${DEBUG_LOGLEVEL:-2}
        env:
        - name: DEBUG_LOGLEVEL
          value: "4"
        # TODO: need to re-enable these
        #livenessProbe:
        #  httpGet:
        #    path: healthz
        #    port: 443
        #    scheme: HTTPS
        #  initialDelaySeconds: 45
        #  timeoutSeconds: 10
        #readinessProbe:
        #  httpGet:
        #    path: healthz/ready
        #    port: 443
        #    scheme: HTTPS
        #  initialDelaySeconds: 10
        #  timeoutSeconds: 10
        volumeMounts:
        - name: master-config
          mountPath: /etc/origin/master/
          readOnly: true
        - name: master-cloud-provider
          mountPath: /etc/origin/cloudprovider/
          readOnly: true
        - name: master-data
          mountPath: /var/lib/origin/
      - name: tunnel
        image: {{ .Values.TunnelImage }}
        imagePullPolicy: Always
        args:
        - /etc/tunnel/tunnel.conf
        securityContext:
          privileged: true
        volumeMounts:
        - name: master-config
          mountPath: /etc/origin/master/
          readOnly: true
        - name: config
          mountPath: /etc/tunnel
          readOnly: true
      volumes:
      - name: master-config
        secret:
          secretName: etc-origin-master
      - name: master-cloud-provider
        secret:
          secretName: etc-origin-cloudprovider
      - name: config
        secret:
          secretName: tunnel
      - name: master-data
        emptyDir: # TODO: BIG FAT WARNING, CHANGE THIS BEFORE PRODUCTION :)
