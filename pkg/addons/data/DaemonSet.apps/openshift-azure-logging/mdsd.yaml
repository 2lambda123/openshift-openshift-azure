apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: mdsd
  namespace: openshift-azure-logging
spec:
  selector:
    matchLabels:
      app: mdsd
  template:
    metadata:
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: ""
      labels:
        app: mdsd
    spec:
      containers:
      - env:
        - name: FLUENTD_CONF
          value: config/fluent.conf
        image: '*** GENERATED ***'
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "LIVENESS_THRESHOLD_SECONDS=${LIVENESS_THRESHOLD_SECONDS:-300}; \nSTUCK_THRESHOLD_SECONDS=${LIVENESS_THRESHOLD_SECONDS:-900};
              \nif [ ! -e /var/log/td-agent/buffer ]; then\n  exit 1;\nfi; \ntouch
              -d \"${STUCK_THRESHOLD_SECONDS} seconds ago\" /tmp/marker-stuck; \nif
              [[ -z \"$(find /var/log/td-agent/buffer -type f -newer /tmp/marker-stuck
              -print -quit)\" ]]; then\n  rm -rf /var/log/td-agent/buffer;\n  exit
              1;\nfi; \ntouch -d \"${LIVENESS_THRESHOLD_SECONDS} seconds ago\" /tmp/marker-liveness;
              \nif [[ -z \"$(find /var/log/td-agent/buffer -type f -newer /tmp/marker-liveness
              -print -quit)\" ]]; then\n  exit 1;\nfi;\n"
          initialDelaySeconds: 30
          periodSeconds: 60
        name: td-agent
        resources:
          limits:
            cpu: 200m
            memory: 800Mi
          requests:
            cpu: 200m
            memory: 200Mi
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/run/mdsd/
          name: socket
          readOnly: true
        - mountPath: /td-agent/config
          name: fluentd-config
        - mountPath: /var/log
          name: hostlog
      - args:
        - -D
        - -R
        - -c
        - /etc/mdsd.d/config/mdsd.xml
        command:
        - mdsd
        env:
        - name: MONITORING_GCS_ACCOUNT
          value: '*** GENERATED ***'
        - name: MONITORING_GCS_ENVIRONMENT
          value: '*** GENERATED ***'
        - name: MONITORING_GCS_REGION
          value: '*** GENERATED ***'
        - name: MONITORING_GCS_CERT_CERTFILE
          value: /etc/mdsd.d/secret/gcscert.pem
        - name: MONITORING_GCS_CERT_KEYFILE
          value: /etc/mdsd.d/secret/gcskey.pem
        image: '*** GENERATED ***'
        name: mdsd
        resources:
          limits:
            cpu: 200m
            memory: 400Mi
          requests:
            cpu: 200m
            memory: 200Mi
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/run/mdsd/
          name: socket
        - mountPath: /etc/mdsd.d/secret
          name: gcs-cert
        - mountPath: /etc/mdsd.d/config
          name: mdsd-config
      hostPID: true
      imagePullSecrets:
      - name: azure-registry
      serviceAccountName: geneva
      tolerations:
      - effect: NoExecute
        operator: Exists
      - effect: NoSchedule
        operator: Exists
      volumes:
      - hostPath:
          path: /var/log
        name: hostlog
      - configMap:
          name: mdsd-config
        name: mdsd-config
      - configMap:
          name: fluentd-config
        name: fluentd-config
      - name: gcs-cert
        secret:
          secretName: gcs-cert
      - emptyDir: {}
        name: socket
